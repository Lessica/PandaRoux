<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      th:fragment="site-base">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" th:href="@{/img/favicon.ico}">
    <title layout:title-pattern="$CONTENT_TITLE | $LAYOUT_TITLE">PandaRoux</title>
    <link th:href="@{/css/bootstrap.css}" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Ubuntu"/>
    <script th:src="@{/js/jquery.min.js}"></script>
    <script th:src="@{/js/bootstrap.js}"></script>
    <script>
        $(function () {

            'use strict';

            console.log("document ready");

            var APIService = {
                init: function () {
                    $.ajaxSetup({
                        method: "POST",
                        dataType: "json",
                        contentType: "application/json; charset=UTF-8",
                        timeout: 10000,
                        error: APIService.errorHandler,
                        async: true
                    });
                },
                errorHandler: function (xmlHTTP, status, httperror) {
                    if (httperror === "timeout") {
                        swal("Oops...", "Connection Timeout (10)", "error");
                    } else {
                        var resp = $.parseJSON(xmlHTTP.responseText);
                        if (resp && resp["message"]) {
                            swal("Oops...", resp['message'], "error");
                        }
                    }
                },
                sessionCheck: function (callback) {
                    $.ajax("/session", {
                        success: callback
                    });
                },
                logout: function (callback) {
                    $.ajax("/logout", {
                        success: callback
                    });
                }
            };

            var SessionController = {

                storage: {
                    logoutButton: $("#logout-button"),
                    sessionButton: $("#session-button")
                },

                init: function () {
                    SessionController.bindEvent();
                    if (SessionController.storage.sessionButton.length > 0) {
                        APIService.sessionCheck(function (resp) {
                            if (resp["name"]) {
                                SessionController.storage.sessionButton.text(resp["name"]);
                                SessionController.storage.logoutButton.data(resp);
                            }
                        });
                    }
                },

                bindEvent: function () {
                    SessionController.storage.logoutButton.click(SessionController.logoutButtonClicked);
                },

                logoutButtonClicked: function (event) {
                    var sender = $(this);
                    var data = sender.data();
                    console.log(data);
                    APIService.logout(function (resp) {
                        window.location.href = "/login";
                    });
                }

            };

            APIService.init();
            SessionController.init();

        });
    </script>
</head>

<body>

<nav class="navbar navbar-default navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
                    aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand header-brand" th:href="@{/}" layout:fragment="nav-header">
                <img class="header-icon" th:src="@{/img/roux.png}">
            </a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
            <ul class="nav navbar-nav" layout:fragment="nav-content">

            </ul>
            <ul id="login-area" class="nav navbar-nav navbar-right" layout:fragment="nav-login">
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button">
                        <span id="session-button"></span> <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a id="logout-button" href="#">Logout</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container-fluid container-main" layout:fragment="container">

</div>

<footer class="footer">
    <div class="container-fluid">
        <p class="text-muted">Copyright 2017 &copy; PandaRoux Team.</p>
    </div>
</footer>

</body>
</html>
